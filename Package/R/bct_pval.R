#' @export
#'
#' @title Compute featurewise p-values of LC-MS data by analysis of variance (ANOVA).
#' @param peaks Input peak data table (matrix)
#' @param info Information table generated by bct.infogen.
#' @param PLOT Logical; should p-value histograms be produced?
#' @param PDF Logical; should a pdf with p-value histograms be produced. Obsolete
#'   command within pipeline, set to F.
#' @param csv Logical; should a .csv file containing the featurewise p-values be produced?
#' @param t Plot title
#' @param adj Logical; should the computed p-values be adjusted (Bonferroni-Holm)?
#' @param plotn Plotting option to compute p-values by information present in information
#'   table. Can be "Group" to compute p-values between sample groups, "Batch" for
#'   p-values between batches, "SeqNr" for p-values between injection sequence indices,
#'   or "All" to compute all of the mentioned p-values.
#' @description Performs ANOVA on the peak data using the information table to compute
#'   p-values per feature. Used to univariately assess the presence of batch effects, as
#'   well as to control if differences between groups (actual variation of interest) is
#'   perserved (courtesy of Prof. C. T. Nakas, Laboratory of Biometry, University of
#'   Thessaly, Volos, Greece).
#' @return Generates a table object containing p-values of all features.

bct.pval <- function(peaks, info, PLOT = TRUE, PDF = FALSE, csv = FALSE, t = "", adj = F,
                     plotn = c("Group", "Batch", "SeqNr", "All"), dens = T) {


  n.p <- ncol(peaks)

  # intialize objects for peaks
  sitep <- rep(0, n.p)
  timep <- rep(0, n.p)
  groupp <- rep(0, n.p)

  if (class(info$SeqNr) != "integer") {
    info$SeqNr <- as.integer(info$SeqNr)
  }
  # get p-values
  for (i in 1:n.p) {
    crudelm <- aov(peaks[, i] ~ factor(info$SCode) + info$Batch + info$SeqNr)
    viasumunl <- unlist(summary(crudelm))
    if(plotn == 'Group' | plotn == 'All'){
      groupp[i - 3] <- viasumunl[["Pr(>F)1"]]
    }
    if(plotn == 'Batch' | plotn == 'All'){
      sitep[i - 3] <- viasumunl[["Pr(>F)2"]]
    }
    if(plotn == 'SeqNr' | plotn == 'All'){
      timep[i - 3] <- viasumunl[["Pr(>F)3"]]
    }
  }

  p.abundances <- matrix()
  p.abundances <- cbind(groupp, sitep, timep)

  if(adj){
    allpadjcb <- as.data.frame(apply(p.abundances, 2, p.adjust, method = "fdr", n = nrow(p.abundances)))
    p.ALL <- cbind(p.abundances, sep = rep(0, nrow(p.abundances)), allpadjcb)
  } else {
    p.ALL <- cbind(p.abundances)
  }

  if (PLOT) {
    if (PDF) {
      pdfname <- readline("Please enter a name for the plotfile, ending in .pdf:\n\n")

      pdf(pdfname)
      hist(groupp, main = paste(t, "Group"), xlab = "P-Value", cex = 3, xlim = c(0,1),
           probability = F, breaks = 20)
      abline(v = median(groupp), lty = 3, col = "red")
      if(dens){
        lines(density(groupp), col = 'blue', lty = 1, lwd = 2)
      }
      legend(x = 'topright', legend(paste("median: ", round(median(groupp), 3))))


      hist(sitep, main = paste(t, "Batch"), xlab = "P-Value", cex = 3, xlim = c(0,1),
           probability = F, breaks = 20)
      abline(v = median(sitep), lty = 3, col = "red")
      if(dens){
        lines(density(sitep)*20, col = 'blue', lty = 1, lwd = 2)
      }
      legend(x = 'topright', legend(paste("median: ", round(median(sitep), 3))))


      hist(timep, main = paste(t, "Order"), xlab = "P-Value", cex = 3, xlim = c(0,1),
           probability = F, breaks = 20)
      abline(v = median(timep), lty = 3, col = "red")
      if(dens){
        lines(density(timep), col = 'blue', lty = 1, lwd = 2)
      }
      legend(x = 'topright', legend(paste("median: ", round(median(timep), 3))))




      if(adj){
        hist(allpadjcb$groupp, main = paste(t, "Group adj"), xlab = "P-Value", cex = 3, xlim = c(0,1),
             probability = F, breaks = 20)
        abline(v = median(allpadjcb$groupp), lty = 3, col = "red")
        if(dens){
          lines(density(allpadjcb$groupp), col = 'blue', lty = 1, lwd = 2)
        }
        legend(x = 'topright', legend = paste("median: ", round(median(alladj$groupp), 3)))


        hist(allpadjcb$sitep, main = paste(t, "Batch adj"), xlab = "P-Value", cex = 3, xlim = c(0,1),
             probability = F, breaks = 20)
        abline(v = median(allpadjcb$sitep), lty = 3, col = "red")
        if(dens){
          lines(density(allpadjcb$sitep), col = 'blue', lty = 1, lwd = 2)
        }
        legend(x = 'topright', legend = paste("median: ", round(median(alladj$sitep), 3)))


        hist(allpadjcb$timep, main = paste(t, "Order adj"), xlab = "P-Value", cex = 3, xlim = c(0,1),
             probability = F, breaks = 20)
        abline(v = median(allpadjcb$timep), lty = 3, col = "red")
        if(dens){
          lines(density(allpadjcb$timep), col = 'blue', lty = 1, lwd = 2)
        }
        legend(x = 'topright', legend = paste("median: ", round(median(alladj$timep), 3)))
      }

      suppressMessages(dev.off())

    } else {
      # par(oma = c(4, 5.5, 5, 3), cex.lab = 1.6, cex.axis = 1.3, cex.main = 2)

      if(plotn == 'Group' | plotn == 'All'){
        hist(groupp, main = paste(t, "Group"), xlab = "P-Value", cex = 3, xlim = c(0,1),
             probability = F, breaks = 20)
        abline(v = median(groupp), lty = 2, col = "red")
        if(dens){
          d <- density(groupp)
          lines(d, col = 'blue', lty = 1, lwd = 2)
        }
        legend(x = 'topright', legend = paste("median: ", round(median(groupp), 3)))
      }

      if(plotn == 'Batch' | plotn == 'All'){
        hist(sitep, main = paste(t, "Batch"), xlab = "P-Value", cex = 3, xlim = c(0,1),
             probability = F, breaks = 20)
        abline(v = median(sitep), lty = 2, col = "red")
        if(dens){
          lines(density(sitep), col = 'blue', lty = 1, lwd = 2)
        }
        legend(x = 'topright', legend = paste("median: ", round(median(sitep), 3)))
      }

      if(plotn == 'SeqNr' | plotn == 'All'){
        hist(timep, main = paste(t, "Order"), xlab = "P-Value", cex = 3, xlim = c(0,1),
             probability = F, breaks = 20)
        abline(v = median(timep), lty = 2, col = "red")
        if(dens){
          lines(density(timep), col = 'blue', lty = 1, lwd = 2)
        }
        legend(x = 'topright', legend = paste("median: ", round(median(timep), 3)))
      }

      if(adj){
        # par(mfrow=c(1,3))
        if(plotn == 'Group' | plotn == 'All'){
          hist(allpadjcb$groupp, main = paste(t, "Group adj"), xlab = "P-Value", cex = 3, xlim = c(0,1),
               probability = F, breaks = 20)
          abline(v = median(allpadjcb$groupp), lty = 2, col = "red")
          if(dens){
            lines(density(allpadjcb$groupp), col = 'blue', lty = 1, lwd = 2)
          }
          legend(x = 'topright', legend = paste("median: ", round(median(alladj$groupp), 3)))
        }
        if(plotn == 'Batch' | plotn == 'All'){
          hist(allpadjcb$sitep, main = paste(t, "Batch adj"), xlab = "P-Value", cex = 3, xlim = c(0,1),
               probability = F, breaks = 20)
          abline(v = median(allpadjcb$sitep), lty = 2, col = "red")
          if(dens){
            lines(density(allpadjcb$sitep), col = 'blue', lty = 1, lwd = 2)
          }
          legend(x = 'topright', legend = paste("median: ", round(median(alladj$sitep), 3)))
        }
        if(plotn == 'SeqNr' | plotn == 'All'){
          hist(allpadjcb$timep, main = paste(t, "Order adj"), xlab = "P-Value", cex = 3, xlim = c(0,1),
               probability = F, breaks = 20)
          abline(v = median(allpadjcb$timep), lty = 2, col = "red")
          if(dens){
            lines(density(allpadjcb$timep), col = 'blue', lty = 1, lwd = 2)
          }
          legend(x = 'topright', legend = paste("median: ", round(median(alladj$timep), 3)))
        }
      }
    }
  }

  if (csv) {
    csvname <- readline("Please enter a name for the table file, ending in .csv:\n\n")
    write.csv(p.ALL, csvname)
  }
  cat("\nComputations complete!\n")
  return(p.ALL)
}
